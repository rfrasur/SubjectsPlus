<?php
require_once __DIR__ . '/../../vendor/autoload.php';
require_once __DIR__ . '/../../lib/LTI13/SP_Database.php';

use \IMSGlobal\LTI;
use Firebase\JWT\JWT;



$launch = LTI\LTI_Message_Launch::new(new SP_Database())
                                ->validate();

$jwt = $_REQUEST['id_token'];

$privateKey = <<<EOD
-----BEGIN PRIVATE KEY-----
MIIEvwIBADANBgkqhkiG9w0BAQEFAASCBKkwggSlAgEAAoIBAQC7VJTUt9Us8cKj
MzEfYyjiWA4R4/M2bS1GB4t7NXp98C3SC6dVMvDuictGeurT8jNbvJZHtCSuYEvu
NMoSfm76oqFvAp8Gy0iz5sxjZmSnXyCdPEovGhLa0VzMaQ8s+CLOyS56YyCFGeJZ
qgtzJ6GR3eqoYSW9b9UMvkBpZODSctWSNGj3P7jRFDO5VoTwCQAWbFnOjDfH5Ulg
p2PKSQnSJP3AJLQNFNe7br1XbrhV//eO+t51mIpGSDCUv3E0DDFcWDTH9cXDTTlR
ZVEiR2BwpZOOkE/Z0/BVnhZYL71oZV34bKfWjQIt6V/isSMahdsAASACp4ZTGtwi
VuNd9tybAgMBAAECggEBAKTmjaS6tkK8BlPXClTQ2vpz/N6uxDeS35mXpqasqskV
laAidgg/sWqpjXDbXr93otIMLlWsM+X0CqMDgSXKejLS2jx4GDjI1ZTXg++0AMJ8
sJ74pWzVDOfmCEQ/7wXs3+cbnXhKriO8Z036q92Qc1+N87SI38nkGa0ABH9CN83H
mQqt4fB7UdHzuIRe/me2PGhIq5ZBzj6h3BpoPGzEP+x3l9YmK8t/1cN0pqI+dQwY
dgfGjackLu/2qH80MCF7IyQaseZUOJyKrCLtSD/Iixv/hzDEUPfOCjFDgTpzf3cw
ta8+oE4wHCo1iI1/4TlPkwmXx4qSXtmw4aQPz7IDQvECgYEA8KNThCO2gsC2I9PQ
DM/8Cw0O983WCDY+oi+7JPiNAJwv5DYBqEZB1QYdj06YD16XlC/HAZMsMku1na2T
N0driwenQQWzoev3g2S7gRDoS/FCJSI3jJ+kjgtaA7Qmzlgk1TxODN+G1H91HW7t
0l7VnL27IWyYo2qRRK3jzxqUiPUCgYEAx0oQs2reBQGMVZnApD1jeq7n4MvNLcPv
t8b/eU9iUv6Y4Mj0Suo/AU8lYZXm8ubbqAlwz2VSVunD2tOplHyMUrtCtObAfVDU
AhCndKaA9gApgfb3xw1IKbuQ1u4IF1FJl3VtumfQn//LiH1B3rXhcdyo3/vIttEk
48RakUKClU8CgYEAzV7W3COOlDDcQd935DdtKBFRAPRPAlspQUnzMi5eSHMD/ISL
DY5IiQHbIH83D4bvXq0X7qQoSBSNP7Dvv3HYuqMhf0DaegrlBuJllFVVq9qPVRnK
xt1Il2HgxOBvbhOT+9in1BzA+YJ99UzC85O0Qz06A+CmtHEy4aZ2kj5hHjECgYEA
mNS4+A8Fkss8Js1RieK2LniBxMgmYml3pfVLKGnzmng7H2+cwPLhPIzIuwytXywh
2bzbsYEfYx3EoEVgMEpPhoarQnYPukrJO4gwE2o5Te6T5mJSZGlQJQj9q4ZB2Dfz
et6INsK0oG8XVGXSpQvQh3RUYekCZQkBBFcpqWpbIEsCgYAnM3DQf3FJoSnXaMhr
VBIovic5l0xFkEHskAjFTevO86Fsz1C2aSeRKSqGFoOQ0tmJzBEs1R6KqnHInicD
TQrKhArgLXX4v3CddjfTRJkFWDbE/CkvKZNOrcf1nhaGCPspRJj2KUkj1Fhl9Cnc
dn/RsYEONbwQSjIfMPkvxF+8HQ==
-----END PRIVATE KEY-----
EOD;

$publicKey = <<<EOD
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu1SU1LfVLPHCozMxH2Mo
4lgOEePzNm0tRgeLezV6ffAt0gunVTLw7onLRnrq0/IzW7yWR7QkrmBL7jTKEn5u
+qKhbwKfBstIs+bMY2Zkp18gnTxKLxoS2tFczGkPLPgizskuemMghRniWaoLcyeh
kd3qqGElvW/VDL5AaWTg0nLVkjRo9z+40RQzuVaE8AkAFmxZzow3x+VJYKdjykkJ
0iT9wCS0DRTXu269V264Vf/3jvredZiKRkgwlL9xNAwxXFg0x/XFw005UWVRIkdg
cKWTjpBP2dPwVZ4WWC+9aGVd+Gyn1o0CLelf4rEjGoXbAAEgAqeGUxrcIlbjXfbc
mwIDAQAB
-----END PUBLIC KEY-----
EOD;

//$jwt2 = "eyJraWQiOiJlNmExNGQ1Ni00MTkwLTRhM2ItYjNkYS03ZDcyODgwOGYxNjMiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiI3ZmIwMTdmNmJlMTI0ZWI1ODg4ZTk3ZTUzYWI3ZjQwMiIsImh0dHBzOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3NwZWNcL2x0aVwvY2xhaW1cL2RlcGxveW1lbnRfaWQiOiI2ZTc3OWQ4Mi1jZTFmLTQ2MjMtYTU0NC1jNmNkNTczZDUxZjIiLCJodHRwczpcL1wvcHVybC5pbXNnbG9iYWwub3JnXC9zcGVjXC9sdGlcL2NsYWltXC92ZXJzaW9uIjoiMS4zLjAiLCJpc3MiOiJodHRwczpcL1wvYmxhY2tib2FyZC5jb20iLCJnaXZlbl9uYW1lIjoiQ2hhcmxlcyBHbGVuIiwibG9jYWxlIjoiZW4tVVMiLCJodHRwczpcL1wvcHVybC5pbXNnbG9iYWwub3JnXC9zcGVjXC9sdGlcL2NsYWltXC9yb2xlcyI6WyJodHRwOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3ZvY2FiXC9saXNcL3YyXC9tZW1iZXJzaGlwI0luc3RydWN0b3IiLCJodHRwOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3ZvY2FiXC9saXNcL3YyXC9zeXN0ZW1cL3BlcnNvbiNBZG1pbmlzdHJhdG9yIiwiaHR0cDpcL1wvcHVybC5pbXNnbG9iYWwub3JnXC92b2NhYlwvbGlzXC92MlwvbWVtYmVyc2hpcCNBZG1pbmlzdHJhdG9yIiwiaHR0cDpcL1wvcHVybC5pbXNnbG9iYWwub3JnXC92b2NhYlwvbGlzXC92MlwvaW5zdGl0dXRpb25cL3BlcnNvbiNTdGFmZiJdLCJub25jZSI6Im5vbmNlLTY0Mjc0ZDhmYzdjMmEyLjgxNTk5MDE2IiwiaHR0cHM6XC9cL3B1cmwuaW1zZ2xvYmFsLm9yZ1wvc3BlY1wvbHRpXC9jbGFpbVwvdG9vbF9wbGF0Zm9ybSI6eyJuYW1lIjoiQmxhY2tib2FyZCwgSW5jLiIsImRlc2NyaXB0aW9uIjoiQmxhY2tib2FyZCwgSW5jLiIsImd1aWQiOiI5MGUzYzFjMTE5N2Y0YTliYmQ0MTc3N2MzMTBmNjMxZCIsInByb2R1Y3RfZmFtaWx5X2NvZGUiOiJCbGFja2JvYXJkTGVhcm4iLCJ2ZXJzaW9uIjoiMzkwMC42Mi4wLXJlbC4xOCtmZjY2MDc0IiwidXJsIjoiaHR0cHM6XC9cL21pYW1pLXRlc3QuYmxhY2tib2FyZC5jb21cLyIsImNvbnRhY3RfZW1haWwiOiJhZG1pbkBtaWFtaS10ZXN0LmJsYWNrYm9hcmQuY29tIn0sImh0dHBzOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3NwZWNcL2x0aVwvY2xhaW1cL3RhcmdldF9saW5rX3VyaSI6Imh0dHBzOlwvXC9kZXYtZS1zdWJqZWN0c3BsdXMuYXp1cmV3ZWJzaXRlcy5uZXRcL2FkZG9uc1wvYmItbHRpXC9sdGkucGhwIiwiaHR0cHM6XC9cL3B1cmwuaW1zZ2xvYmFsLm9yZ1wvc3BlY1wvbHRpXC9jbGFpbVwvY29udGV4dCI6eyJpZCI6ImZmNzVlMzhjNzI5YTRkNmZiNmI2ZTU4YjQ2NDgxZGI4IiwibGFiZWwiOiJISVM1MzYtNDMtMTExMDEtMS0yMDIzMSIsInRpdGxlIjoiMjAyMzEgLSBISVM1MzZcLzYzNi00MyAtIE1FUkdFRCAtIFN0dWRpZXMgaW4gTWVkaWV2YWwgSGlzdG9yeSAoU3ByaW5nIDIwMjMpIiwidHlwZSI6WyJodHRwOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3ZvY2FiXC9saXNcL3YyXC9jb3Vyc2UjQ291cnNlT2ZmZXJpbmciXX0sImh0dHBzOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3NwZWNcL2x0aVwvY2xhaW1cL3Jlc291cmNlX2xpbmsiOnsiaWQiOiJfNjZfMVN1YmplY3RQbHVzVGVzdCJ9LCJodHRwczpcL1wvcHVybC5pbXNnbG9iYWwub3JnXC9zcGVjXC9sdGlcL2NsYWltXC9jdXN0b20iOnsiY291cnNlX2lkIjoiXC9jb3Vyc2VzXC8xXC9ISVM1MzYtNDMtMTExMDEtMS0yMDIzMVwvIiwiYmxhY2tib2FyZF9jb3Vyc2VfaWQiOiJfNjZfMSIsImNhbGlwZXJfcHJvZmlsZV91cmwiOiJodHRwczpcL1wvbWlhbWktdGVzdC5ibGFja2JvYXJkLmNvbVwvbGVhcm5cL2FwaVwvdjFcL3RlbGVtZXRyeVwvY2FsaXBlclwvcHJvZmlsZSIsImNvdXJzZV9uYW1lIjoiMjAyMzEgLSBISVM1MzZcLzYzNi00MyAtIE1FUkdFRCAtIFN0dWRpZXMgaW4gTWVkaWV2YWwgSGlzdG9yeSAoU3ByaW5nIDIwMjMpIiwiY2FsaXBlcl9mZWRlcmF0ZWRfc2Vzc2lvbl9pZCI6Imh0dHBzOlwvXC9jYWxpcGVyLW1hcHBpbmcuY2xvdWRiYi5ibGFja2JvYXJkLmNvbVwvdjFcL3NpdGVzXC9iZTFjNzc1MS1lYmE3LTQwNjgtYjVjZC1iMDk3MDc1M2MwMThcL3Nlc3Npb25zXC8wMjJEQzU4Q0VFOUU1N0VFQkM5NkI1MUQzMUFFREY3MSIsInVzZXJfZnVsbF9uYW1lIjoiQ2hhcmxlcyBHbGVuIEJyb3duLVJvYmVydHMiLCJjb3Vyc2VfdXJsIjoiXC9jb3Vyc2VzXC8xXC9ISVM1MzYtNDMtMTExMDEtMS0yMDIzMVwvIiwiY29udGVudF91cmwiOiJAWEBjb250ZW50LnVybEBYQCIsImxhYmVsIjoiSElTNTM2LTQzLTExMTAxLTEtMjAyMzEiLCJ0aXRsZSI6IjIwMjMxIC0gSElTNTM2XC82MzYtNDMgLSBNRVJHRUQgLSBTdHVkaWVzIGluIE1lZGlldmFsIEhpc3RvcnkgKFNwcmluZyAyMDIzKSIsInByaW1hcnlfa2V5IjoiXzY2XzEifSwiYXVkIjoiMDhjYWJhYmMtYzE0MC00OTJhLTk5YzEtMWJhYTVhNTI0MGRkIiwiaHR0cHM6XC9cL3B1cmwuaW1zZ2xvYmFsLm9yZ1wvc3BlY1wvbHRpXC9jbGFpbVwvbWVzc2FnZV90eXBlIjoiTHRpUmVzb3VyY2VMaW5rUmVxdWVzdCIsIm5hbWUiOiJDaGFybGVzIEdsZW4gQnJvd24tUm9iZXJ0cyIsImh0dHBzOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3NwZWNcL2x0aVwvY2xhaW1cL2xpcyI6eyJwZXJzb25fc291cmNlZGlkIjoiY2dicm9iZXJ0cyIsImNvdXJzZV9zZWN0aW9uX3NvdXJjZWRpZCI6IkhJUzUzNi00My0xMTEwMS0xLTIwMjMxIn0sImh0dHBzOlwvXC9wdXJsLmltc2dsb2JhbC5vcmdcL3NwZWNcL2x0aVwvY2xhaW1cL2xhdW5jaF9wcmVzZW50YXRpb24iOnsiZG9jdW1lbnRfdGFyZ2V0Ijoid2luZG93IiwicmV0dXJuX3VybCI6Imh0dHBzOlwvXC9taWFtaS10ZXN0LmJsYWNrYm9hcmQuY29tXC93ZWJhcHBzXC9ibGFja2JvYXJkXC9leGVjdXRlXC9ibHRpXC9sYXVuY2hSZXR1cm4_Y291cnNlX2lkPV82Nl8xJm5vbmNlPTk0ZDQ2NjIyOGE5ODQwMzhhMmI2OTc4NGRiNWE5YWRjJmxhdW5jaF9pZD05YTcxNGRlNC1hOWMzLTRjMzktYmExNy1lZGI3OTBhOTczZTMmbGlua19pZD1fNjZfMVN1YmplY3RQbHVzVGVzdCZsYXVuY2hfdGltZT0xNjgwMjk3MzYwMDkwIiwibG9jYWxlIjoiZW4tVVMifSwiZXhwIjoxNjgwMzAwOTYwLCJpYXQiOjE2ODAyOTczNjAsImZhbWlseV9uYW1lIjoiQnJvd24tUm9iZXJ0cyIsImh0dHBzOlwvXC9ibGFja2JvYXJkLmNvbVwvbHRpXC9jbGFpbVwvb25lX3RpbWVfc2Vzc2lvbl90b2tlbiI6ImY0MDZkOTVlYjM0ZDQ4N2Y5MTc1MTgwMmVlZDA1NzU2IiwiaHR0cHM6XC9cL2JsYWNrYm9hcmQuY29tXC93ZWJhcHBzXC9mb3VuZGF0aW9ucy1jb25uZWN0b3JcL2ZvdW5kYXRpb25zLWlkcyI6eyJjb3Vyc2UtaWQiOiIyN2E0NDIyOC1jOWEwLTExZWQtOWNjNC1kNTk3NjQ4MjIzMmQiLCJ1c2VyLWlkIjoiNDhkNTg0NTYtOWJmNy0xMWVkLWJhOGQtNTlkMDYyOGE0NmFjIiwic2l0ZS1pZCI6ImJlMWM3NzUxLWViYTctNDA2OC1iNWNkLWIwOTcwNzUzYzAxOCIsInJlZ2lvbiI6InVzLWVhc3QtMSIsInRlbmFudC1pZCI6Ijg0MjExY2YwLTg5ZDYtNGJiZi1hOTlhLWM2MTI2MjhlMjk3NyJ9fQ.Z6l9yBzYFPCNTizBltv9p951iMHiIhB-3a-21jm5KoBrYcog6AcFg5Ef7kz3uPvy0hA_FpDTPnSJkLFNrCs2XZtVKtYVQqVa4rgD57xrxn9-JtsNYeMZ2skYYYLJPDCwUi5Rm90xrnJrsHBgO6sGSB9NGy92Uv09yQwcp05dQNgTnSO_-t1BSShbQS7w42lJtlMon4U-GgvhrbR9z1l2DaqQ2XDZArFTb2rxTMlSjiiIqm5o_0T3aQ90t2Aagd7_0WmzL5fVqYKP7G3pcbOElsecm1AkjelDYufHsOHjKjeXlCKbCO_20X_DaCUAOoHy-OHaOBwQtOw-I3bFr8HVig";


$jwt4 = json_decode(base64_decode(str_replace('_', '/', str_replace('-','+',explode('.', $jwt)[1]))), true)['https://purl.imsglobal.org/spec/lti/claim/custom']['label'];
var_dump($jwt4);


die();

try {
    require_once __DIR__ . '/../../control/includes/config.php';

    global $lti_enabled;
    global $PublicPath;
    $guide_path = $PublicPath;

    require_once __DIR__ . '/../../control/includes/functions.php';
    require_once __DIR__ . '/../../control/lti_controller/LTICourseController.php';

    // TODO: require course_id instead of context_label
    if (isset($lti_enabled) && $lti_enabled) {
        $course_label = scrubData($_REQUEST["context_label"]);
        $courses_code = new LTICourseController('bb_course_code', 'bb_course_instructor');
        $courses_code->processCourseCode($course_label, $guide_path);

    } else {
        header("Location: " . $guide_path . "?invalid_lti_call=1"); /* Redirect browser */
    }

} catch (Exception $e) {
    echo 'Exception "\n"', $e->getMessage(), "\n";
    exit();
}
